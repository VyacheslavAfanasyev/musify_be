# Публикация @app/shared в NPM

Этот документ описывает процесс публикации пакета `@app/shared` в NPM для использования в продакшене.

## Предварительные требования

1. **NPM аккаунт**: Убедитесь, что у вас есть аккаунт на [npmjs.com](https://www.npmjs.com/)
2. **Авторизация**: Выполните вход в NPM:
   ```bash
   npm login
   ```
3. **Организация/Scope**: Пакет использует scope `@app`, поэтому убедитесь, что:
   - У вас есть права на публикацию пакетов с этим scope, или
   - Создайте организацию `@app` в NPM, или
   - Измените scope в `package.json` на ваш собственный

## Структура пакета

После сборки пакет содержит:
- `dist/` - скомпилированные JavaScript файлы и TypeScript декларации
- `README.md` - документация пакета
- `CHANGELOG.md` - история изменений версий

## Процесс публикации

### 1. Подготовка к публикации

Убедитесь, что все изменения закоммичены и версия обновлена:

```bash
# Проверить текущую версию
npm run shared:version

# Обновить версию (если необходимо)
npm run shared:version:patch  # для bug fixes
npm run shared:version:minor  # для новых функций
npm run shared:version:major  # для breaking changes
```

### 2. Сборка пакета

Перед публикацией пакет автоматически собирается благодаря хуку `prepublishOnly`:

```bash
# Ручная сборка (опционально, для проверки)
npm run shared:build
```

### 3. Публикация

#### Вариант 1: Публикация с автоматическим обновлением версии

```bash
# Patch версия (1.0.0 -> 1.0.1)
npm run shared:publish:patch

# Minor версия (1.0.0 -> 1.1.0)
npm run shared:publish:minor

# Major версия (1.0.0 -> 2.0.0)
npm run shared:publish:major
```

#### Вариант 2: Публикация текущей версии

```bash
npm run shared:publish
```

### 4. Проверка публикации

После публикации проверьте, что пакет доступен:

```bash
npm view @app/shared
```

Или посетите: `https://www.npmjs.com/package/@app/shared`

## Использование в микросервисах

После публикации пакета обновите зависимости в микросервисах:

### Для разработки (локально)

Можно продолжать использовать локальную версию через npm workspaces:

```json
{
  "dependencies": {
    "@app/shared": "file:../../shared"
  }
}
```

### Для продакшена

Используйте опубликованный NPM пакет:

```json
{
  "dependencies": {
    "@app/shared": "^1.0.0"
  }
}
```

Или с автоматическим обновлением patch версий:

```json
{
  "dependencies": {
    "@app/shared": "~1.0.0"
  }
}
```

Или с автоматическим обновлением minor версий:

```json
{
  "dependencies": {
    "@app/shared": "^1.0.0"
  }
}
```

### Миграция микросервисов

Для миграции микросервиса с локальной версии на NPM пакет:

1. Обновите `package.json` микросервиса:
   ```json
   {
     "dependencies": {
       "@app/shared": "^1.0.0"  // вместо "file:../../shared"
     }
   }
   ```

2. Установите зависимости:
   ```bash
   npm install
   ```

3. Обновите `tsconfig.json` (если необходимо):
   ```json
   {
     "compilerOptions": {
       "paths": {
         // Удалите эти строки, если используете NPM пакет
         // "@app/shared": ["../../shared/index.ts"],
         // "@app/shared/*": ["../../shared/*"]
       }
     }
   }
   ```

4. Обновите Dockerfile (если необходимо):
   - Удалите копирование локальной папки `shared`
   - Убедитесь, что `npm install` установит пакет из NPM

## Версионирование

Пакет следует [Semantic Versioning](https://semver.org/):

- **PATCH** (1.0.0 -> 1.0.1): Исправления багов, не ломающие API
- **MINOR** (1.0.0 -> 1.1.0): Новые функции, обратно совместимые
- **MAJOR** (1.0.0 -> 2.0.0): Breaking changes

Все изменения должны быть задокументированы в `CHANGELOG.md`.

## Troubleshooting

### Ошибка: "You do not have permission to publish"

Убедитесь, что:
1. Вы авторизованы: `npm whoami`
2. У вас есть права на публикацию пакетов с scope `@app`
3. Или измените scope в `package.json`

### Ошибка: "Package name already exists"

Пакет с таким именем уже существует. Либо:
1. Используйте другое имя
2. Или обновите существующий пакет (увеличьте версию)

### Пакет не обновляется после публикации

NPM кэширует пакеты. Подождите несколько минут или используйте:
```bash
npm cache clean --force
```

## CI/CD интеграция

Для автоматической публикации в CI/CD можно использовать:

```yaml
# Пример для GitHub Actions
- name: Publish to NPM
  run: |
    npm run shared:publish:patch
  env:
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

Убедитесь, что `NPM_TOKEN` настроен в секретах вашего CI/CD.

## Откат версии

Если нужно откатить версию:

1. Увеличьте версию в `package.json`
2. Опубликуйте новую версию с исправлениями
3. Или используйте `npm deprecate` для пометки версии как устаревшей:
   ```bash
   npm deprecate @app/shared@1.0.0 "Эта версия содержит баг, используйте 1.0.1"
   ```

